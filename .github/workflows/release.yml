name: Create Release

on:
  workflow_run:
    workflows: ["build"]
    types: [completed]

permissions:
  contents: write

jobs:
  release:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'
    runs-on: ubuntu-latest

    steps:
    - name: üßæ Checkout repo
      uses: actions/checkout@v4

    - name: üîç Extract CURRENT_VERSION
      id: extract
      run: |
        VERSION=$(grep -oP 'CURRENT_VERSION\s*=\s*"\K[^"]+' src/bot/main.py)
        echo "VERSION=$VERSION" | tee -a $GITHUB_ENV

    # ------------------------------------------------------------
    # Download artifacts for this run with the GitHub REST API
    # ------------------------------------------------------------
    - name: üîΩ Fetch artifact list & download
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        RUN_ID=${{ github.event.workflow_run.id }}
        API="https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts"
        mkdir artifacts

        curl -sSL -H "Authorization: token $GH_TOKEN" "$API" | \
          jq -r '.artifacts[] | select(.name|startswith("binaries-")) | [.name,.archive_download_url] | @tsv' |
        while IFS=$'\t' read -r NAME URL; do
          echo "‚è¨  $NAME"
          curl -sSL -H "Authorization: token $GH_TOKEN" -H "Accept: application/vnd.github+json" \
               "$URL" -o "$NAME.zip"
          unzip -q "$NAME.zip" -d "artifacts/$NAME"
        done

        echo "Downloaded structure:"
        find artifacts -maxdepth 2 -type f

    # ------------------------------------------------------------
    # Re-package per OS
    # ------------------------------------------------------------
    - name: üì¶ Zip watcher+updater for each OS
      run: |
        set -e
        mkdir -p release_zips

        # Windows
        cp artifacts/binaries-windows-latest/main.exe    watcher.exe
        cp artifacts/binaries-windows-latest/updater.exe updater.exe
        zip -qj release_zips/atsuko-nexus-windows-x64.zip watcher.exe updater.exe

        # Linux
        cp artifacts/binaries-ubuntu-latest/main    watcher
        cp artifacts/binaries-ubuntu-latest/updater updater
        chmod +x watcher updater
        zip -qj release_zips/atsuko-nexus-linux-x64.zip watcher updater

        # macOS
        cp artifacts/binaries-macos-latest/main    watcher
        cp artifacts/binaries-macos-latest/updater updater
        chmod +x watcher updater
        zip -qj release_zips/atsuko-nexus-macos-x64.zip watcher updater

    - name: üîñ Generate changelog from last tag
      id: changelog
      run: |
        set -e

        # Ensure full history
        git fetch --tags --unshallow || true
        git fetch origin main

        # Last tag that is NOT the current version
        LAST_TAG=$(git tag --sort=-creatordate | grep -v "^${VERSION}$" | head -n1 || true)
        echo "Previous tag: ${LAST_TAG:-<none>}"

        RANGE=""
        if [ -n "$LAST_TAG" ]; then
          RANGE="$LAST_TAG..HEAD"
        fi

        get_list () {
          KEY="$1"
          git log $RANGE \
            --no-merges \
            --pretty=format:"- %s (%h)" \
            --grep="^\[${KEY}\]" --regexp-ignore-case |
          sed -E "s/^\[${KEY}\] //I" || true
        }

        ADDED  =$(get_list "ADD")
        REMOVED=$(get_list "REMOVE")
        FIXED  =$(get_list "FIX")

        # fallback to N/A when empty
        [[ -z "$ADDED"   ]] && ADDED="N/A"
        [[ -z "$REMOVED" ]] && REMOVED="N/A"
        [[ -z "$FIXED"   ]] && FIXED="N/A"

        {
          echo "## Changes in ${VERSION}"
          echo
          echo "**Added:**"
          echo "$ADDED"
          echo
          echo "**Removed:**"
          echo "$REMOVED"
          echo
          echo "**Fixed:**"
          echo "$FIXED"
        } > release_notes.md

        echo "--- release notes ---"
        cat release_notes.md
        echo "---------------------"

    # ------------------------------------------------------------
    # Create or update release
    # ------------------------------------------------------------
    - name: üöÄ Create / update GitHub release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        TAG="$VERSION"
        TITLE="Atsuko Nexus $VERSION"

        if gh release view "$TAG" &>/dev/null; then
          echo "‚ÑπÔ∏è  Release $TAG exists ‚Äì will upload missing assets."
          EXISTING_ASSETS=$(gh release view "$TAG" --json assets -q '.assets[].name')
          for ZIP in release_zips/*; do
            NAME=$(basename "$ZIP")
            if echo "$EXISTING_ASSETS" | grep -qx "$NAME"; then
              echo "‚úîÔ∏è  Asset $NAME already present."
            else
              echo "‚ûï Uploading $NAME"
              gh release upload "$TAG" "$ZIP" --clobber
            fi
          done
        else
          echo "üÜï Creating release $TAG"
          gh release create "$TAG" release_zips/* \
            --title "$TITLE" \
            --notes-file release_notes.md
        fi